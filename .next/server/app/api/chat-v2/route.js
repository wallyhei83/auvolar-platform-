(()=>{var a={};a.id=5481,a.ids=[5481],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:a=>{"use strict";a.exports=require("punycode")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},27910:a=>{"use strict";a.exports=require("stream")},28354:a=>{"use strict";a.exports=require("util")},29021:a=>{"use strict";a.exports=require("fs")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{"use strict";a.exports=require("path")},37830:a=>{"use strict";a.exports=require("node:stream/web")},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},53139:()=>{},55591:a=>{"use strict";a.exports=require("https")},56935:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>J,patchFetch:()=>I,routeModule:()=>E,serverHooks:()=>H,workAsyncStorage:()=>F,workUnitAsyncStorage:()=>G});var d={};c.r(d),c.d(d,{POST:()=>C});var e=c(35776),f=c(24085),g=c(29892),h=c(11110),i=c(93292),j=c(261),k=c(74570),l=c(95672),m=c(4120),n=c(69339),o=c(42805),p=c(99991),q=c(82329),r=c(7054),s=c(86439),t=c(39172),u=c(9145),v=c(89512);class w{constructor(a){this.openai=new v.Ay({apiKey:a})}async analyzeCompany(a,b){let c="";if(b)try{let a=await fetch(b);c=(await a.text()).replace(/<[^>]*>/g," ").replace(/\s+/g," ").slice(0,3e3)}catch(a){console.log("Could not fetch website:",a)}let d=`
    Analyze this company for B2B LED lighting sales approach:
    
    Company: ${a}
    Website: ${b||"Not provided"}
    Website Content: ${c||"Not available"}
    
    Provide analysis in this exact JSON format:
    {
      "industry": "specific industry (e.g., manufacturing, retail, healthcare)",
      "size": "startup|smb|enterprise|fortune500",
      "description": "brief company description",
      "painPoints": ["lighting-related pain point 1", "pain point 2"],
      "budgetEstimate": "low|medium|high|enterprise",
      "decisionMakers": ["likely decision maker roles"],
      "competitors": ["potential competitor companies they might compare us to"]
    }
    
    Focus on lighting-related insights and business intelligence for sales strategy.
    `;try{let c=await this.openai.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"user",content:d}],temperature:.3}),e=c.choices[0]?.message?.content||"{}",f=JSON.parse(e);return{name:a,website:b||"",industry:f.industry||"unknown",size:f.size||"smb",description:f.description||"",recentNews:[],competitors:f.competitors||[],painPoints:f.painPoints||[],budgetEstimate:f.budgetEstimate||"medium",decisionMakers:f.decisionMakers||[],contactInfo:{}}}catch(c){return console.error("Company analysis failed:",c),{name:a,website:b||"",industry:"unknown",size:"smb",description:"",recentNews:[],competitors:[],painPoints:[],budgetEstimate:"medium",decisionMakers:[],contactInfo:{}}}}analyzeJobRole(a){let b={"facilities manager":{communicationStyle:"direct",priorities:["cost control","maintenance","reliability"],concerns:["downtime","ongoing costs","warranty"],approach:"Emphasize ROI, maintenance savings, and reliability"},"procurement director":{communicationStyle:"analytical",priorities:["cost comparison","specifications","vendor evaluation"],concerns:["price","quality standards","delivery"],approach:"Provide detailed specs, competitive analysis, volume pricing"},"electrical engineer":{communicationStyle:"technical",priorities:["technical specs","performance","standards compliance"],concerns:["light quality","installation requirements","code compliance"],approach:"Deep technical discussion, IES files, photometric data"},cfo:{communicationStyle:"analytical",priorities:["ROI","cash flow impact","tax benefits"],concerns:["payback period","budget constraints","financial risk"],approach:"Focus on financial returns, rebates, tax incentives"},"property manager":{communicationStyle:"relationship",priorities:["tenant satisfaction","property value","operating costs"],concerns:["disruption","appearance","long-term value"],approach:"Emphasize tenant benefits, property enhancement, minimal disruption"}},c=a.toLowerCase();for(let a in b)if(c.includes(a)||a.includes(c))return b[a];return{communicationStyle:"professional",priorities:["value","quality","service"],concerns:["price","reliability","support"],approach:"Balanced approach focusing on value and service"}}async analyzeMessageSentiment(a){let b=`
    Analyze this customer message for sales insights:
    
    "${a}"
    
    Respond in JSON format:
    {
      "sentiment": "positive|neutral|negative",
      "engagement": 0-100 (interest level),
      "intent": ["intent1", "intent2"],
      "urgency": "low|medium|high"
    }
    
    Intent examples: price_inquiry, technical_specs, timeline_request, objection, ready_to_buy
    `;try{let a=await this.openai.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"user",content:b}],temperature:.2}),c=a.choices[0]?.message?.content||"{}";return JSON.parse(c)}catch(a){return console.error("Sentiment analysis failed:",a),{sentiment:"neutral",engagement:50,intent:["general_inquiry"],urgency:"medium"}}}}class x{static generateStrategy(a,b){let c={tone:"professional",approach:"consultative",priorities:[],tactics:[]};switch(a.communicationStyle){case"direct":c.tone="direct",c.approach="solution-focused",c.tactics.push("cut_to_chase","bottom_line_first");break;case"analytical":c.tone="professional",c.approach="data-driven",c.tactics.push("provide_specs","show_comparisons","roi_analysis");break;case"expressive":c.tone="enthusiastic",c.approach="relationship-building",c.tactics.push("build_rapport","share_stories","emotional_benefits");break;case"relationship":c.tone="warm",c.approach="trust-building",c.tactics.push("personal_touch","share_case_studies","long_term_partnership")}switch(b?.size||a.companySize){case"enterprise":case"fortune500":c.priorities.push("scalability","enterprise_support","volume_pricing"),c.tactics.push("enterprise_solutions","dedicated_support");break;case"startup":c.priorities.push("cost_efficiency","flexibility","growth_support"),c.tactics.push("startup_friendly_terms","future_expansion");break;default:c.priorities.push("value","reliability","service"),c.tactics.push("balanced_approach")}return"high"===a.priceSensitivity&&(c.priorities.unshift("cost_savings","roi","rebates"),c.tactics.push("emphasize_savings","rebate_calculator")),c}static updateStrategyEffectiveness(a,b,c){return a.strategyEffectiveness||(a.strategyEffectiveness={}),a.strategyEffectiveness[b]=c,a.lastUpdated=new Date,a}}class y{constructor(a){this.openai=new v.Ay({apiKey:a})}async processVoice(a){try{let b=new Uint8Array(a),c=new Blob([b],{type:"audio/wav"}),d=new File([c],"audio.wav",{type:"audio/wav"});return(await this.openai.audio.transcriptions.create({file:d,model:"whisper-1"})).text}catch(a){return console.error("Voice processing failed:",a),"Sorry, I could not process that audio message. Could you type your question instead?"}}async processImage(a){try{let b=await this.openai.chat.completions.create({model:"gpt-4-vision-preview",messages:[{role:"user",content:[{type:"text",text:"Analyze this image for lighting needs. What type of space is this? What lighting challenges do you see? What would you recommend?"},{type:"image_url",image_url:{url:a}}]}],max_tokens:500});return b.choices[0]?.message?.content||"I can see the image but could not analyze it. Could you describe what lighting help you need?"}catch(a){return console.error("Image processing failed:",a),"I had trouble analyzing that image. Could you describe your lighting needs in text?"}}async processPDF(a){return"I received your PDF document. I can see it contains project specifications. Could you highlight the key lighting requirements you need help with?"}async generateVoice(a){try{let b=await this.openai.audio.speech.create({model:"tts-1",voice:"alloy",input:a});return Buffer.from(await b.arrayBuffer())}catch(a){throw console.error("Voice generation failed:",a),Error("Could not generate voice response")}}}class z{constructor(){this.productKnowledge=this.initializeProductKnowledge()}initializeProductKnowledge(){return{products:{"ot-series":{name:"OT Series Area Light",series:"OT",watts:[100,150,200,240,320,480],lumens:[14e3,21e3,28e3,33600,44800,67200],prices:[149,179,199,239,299,399],applications:["Parking lots","Walkways","Building perimeter","Security lighting"],features:["130-140 lm/W efficiency","5000K/4000K CCT options","Type III/IV/V distributions","0-10V dimming","Surge protection","DLC Premium listed"],specifications:{cct:["4000K","5000K"],cri:">70",efficiency:"130-140 lm/W",warranty:"5 years",certifications:["UL Listed","DLC Premium","FCC Compliant"],operating_temp:"-40\xb0F to 104\xb0F (-40\xb0C to 40\xb0C)",lifespan:"L70 >100,000 hours",dimensions:["Various based on wattage"],mounting:["Slip fitter","Yoke mount","Trunnion mount"]}},"plb-series":{name:"PLB Series Parking Lot Light",series:"PLB",watts:[100,150,200,240,320],lumens:[13e3,19500,26e3,31200,41600],prices:[139,169,189,219,269],applications:["Parking lots","Roadways","Commercial areas","Campus lighting"],features:["130+ lm/W efficiency","Multiple optics available","Robust die-cast housing","Photocell ready","Motion sensor compatible"],specifications:{cct:["4000K","5000K"],cri:">70",efficiency:"130+ lm/W",warranty:"5 years",certifications:["UL Listed","DLC Premium"],operating_temp:"-40\xb0F to 104\xb0F",lifespan:"L70 >100,000 hours",dimensions:["Compact shoebox design"],mounting:["Slip fitter","Yoke mount"]}},"isf-series":{name:"ISF Series Stadium Light",series:"ISF",watts:[400,500,600,800,1e3,1200,1500,1800],lumens:[56e3,7e4,84e3,112e3,14e4,168e3,21e4,252e3],prices:[499,599,699,899,1099,1299,1599,1899],applications:["Sports facilities","Stadium lighting","Large area illumination","Industrial high bay"],features:["140+ lm/W efficiency","Multiple beam angles","Professional sports lighting","Advanced heat management","Precise optical control"],specifications:{cct:["4000K","5000K"],cri:">80",efficiency:"140+ lm/W",warranty:"5 years",certifications:["UL Listed","DLC Premium"],operating_temp:"-40\xb0F to 122\xb0F",lifespan:"L70 >100,000 hours",dimensions:["Heavy-duty housing"],mounting:["Multiple mounting options"]}},"ins-series":{name:"INS Series Stadium Light",series:"INS",watts:[300,400,500,600,720,1e3,1200,1500,1800],lumens:[42e3,56e3,7e4,84e3,100800,14e4,168e3,21e4,252e3],prices:[399,499,599,699,799,1099,1299,1599,1899],applications:["Sports lighting","Stadium illumination","High-mast lighting","Large venues"],features:["140+ lm/W efficiency","IP67 rating","IK10 impact resistance","Multiple beam distributions","Flicker-free operation"],specifications:{cct:["4000K","5000K"],cri:">80",efficiency:"140+ lm/W",warranty:"5 years",certifications:["UL Listed","DLC Premium","IK10","IP67"],operating_temp:"-40\xb0F to 122\xb0F",lifespan:"L70 >100,000 hours",dimensions:["Rugged design"],mounting:["Yoke mount","Slip fitter"]}}},applications:{parking_lot:{recommended_products:["ot-series","plb-series"],key_considerations:["Coverage area","Pole height","Security requirements","Energy efficiency"],common_challenges:["Dark spots","Over-lighting","High energy costs","Maintenance access"],success_metrics:["Uniform illumination","Energy savings","Reduced maintenance","Enhanced security"]},warehouse:{recommended_products:["ins-series","isf-series"],key_considerations:["Ceiling height","Aisle width","Task requirements","Operational hours"],common_challenges:["Shadow areas","Glare control","Energy costs","Installation disruption"],success_metrics:["Productivity improvement","Safety enhancement","Energy reduction","ROI achievement"]},sports_facility:{recommended_products:["isf-series","ins-series"],key_considerations:["Sport type","Competition level","TV broadcasting","Spectator comfort"],common_challenges:["Glare control","Uniform illumination","Light spillage","Player performance"],success_metrics:["Lighting uniformity","Glare reduction","Energy efficiency","Broadcast quality"]}},competitors:{lithonia:{strengths:["Brand recognition","Wide distribution","Product variety"],weaknesses:["Higher prices","Lower efficiency","Complex ordering"],pricing_position:"Premium",our_advantages:["Better efficiency","Direct pricing","Faster delivery","Superior warranty"]},cree:{strengths:["Technology reputation","Innovation","Quality perception"],weaknesses:["Very high prices","Limited availability","Long lead times"],pricing_position:"Premium+",our_advantages:["Much better value","Immediate availability","Same quality","Better support"]},cooper_eaton:{strengths:["Market presence","Established channels","Product range"],weaknesses:["Legacy thinking","Slower innovation","Higher costs"],pricing_position:"Premium",our_advantages:["Modern approach","Better efficiency","Competitive pricing","Agile service"]}}}}generatePersonalizedPrompt(a,b,c){let d=x.generateStrategy(a,b),e=`You are Alex, an elite AI Sales Representative at Auvolar - the most advanced lighting sales AI in the industry. You combine three expert roles:

ğŸ”¬ **TECHNICAL EXPERT**: Deep lighting engineering knowledge, photometric analysis, energy calculations
ğŸ’¼ **SALES MASTER**: Advanced negotiation, objection handling, relationship building
ğŸ¤ **PARTNERSHIP BUILDER**: Long-term relationship focus, consultative approach, trust establishment

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CURRENT CLIENT INTELLIGENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,f="";a.name&&(f+=`
ğŸ‘¤ **Client**: ${a.name}`),a.position&&(f+=`
ğŸ’¼ **Role**: ${a.position}`),a.company&&(f+=`
ğŸ¢ **Company**: ${a.company}`),b&&(f+=`
ğŸ­ **Industry**: ${b.industry}
ğŸ“ **Size**: ${b.size}`,b.painPoints.length>0&&(f+=`
âš ï¸ **Pain Points**: ${b.painPoints.join(", ")}`));let g=`
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ADAPTIVE STRATEGY FOR THIS CLIENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ **Communication Style**: ${d.tone} (${d.approach})
ğŸ“‹ **Priorities**: ${d.priorities.join(", ")}
ğŸ› ï¸ **Tactics**: ${d.tactics.join(", ")}

**Role-Based Approach**: ${this.getRoleBasedGuidance(a.position||"")}
`,h=`
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COMPLETE PRODUCT KNOWLEDGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## OT SERIES AREA LIGHTS (Parking/Walkway/Perimeter)
- **Power Options**: 100W-480W ($149-$399)
- **Efficiency**: 130-140 lm/W 
- **Applications**: Parking lots, walkways, security lighting
- **Key Features**: Type III/IV/V optics, 5-year warranty, DLC Premium
- **Competitive Edge**: 20% more efficient than Lithonia at 30% less cost

## PLB SERIES PARKING LOT LIGHTS  
- **Power Options**: 100W-320W ($139-$269)
- **Efficiency**: 130+ lm/W
- **Applications**: Parking lots, roadways, commercial areas
- **Key Features**: Compact shoebox design, photocell ready
- **Competitive Edge**: Direct replacement for legacy fixtures

## ISF SERIES STADIUM LIGHTS (Professional Sports)
- **Power Options**: 400W-1800W ($499-$1,899)
- **Efficiency**: 140+ lm/W
- **Applications**: Sports facilities, stadium lighting, large areas
- **Key Features**: Professional optics, advanced thermal management
- **Competitive Edge**: Broadcast-quality lighting at 40% less than Cree

## INS SERIES STADIUM LIGHTS (Heavy Duty)
- **Power Options**: 300W-1800W ($399-$1,899) 
- **Efficiency**: 140+ lm/W
- **Applications**: Sports, high-mast, industrial
- **Key Features**: IP67/IK10 rating, multiple beam angles
- **Competitive Edge**: Most rugged fixture in class

## UNIVERSAL ADVANTAGES
âœ… **Warranty**: 5 years (industry-leading)
âœ… **Efficiency**: 130-140+ lm/W (top-tier performance)
âœ… **Certifications**: UL Listed, DLC Premium (rebate eligible)
âœ… **Availability**: Ships same day from California
âœ… **Support**: Direct technical support, no middleman
âœ… **Pricing**: 20-40% less than Cree/Lithonia with same quality
`,i=`
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INTELLIGENT SALES PROCESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## DISCOVERY SEQUENCE
1. **Company Intelligence**: "What's your company name and website so I can understand your business better?"
2. **Role Analysis**: "What's your role there?" (Adapt strategy based on position)
3. **Project Scope**: "Tell me about your lighting project - what area and challenges?"
4. **Pain Point Exploration**: Use SPIN methodology to uncover needs

## RECOMMENDATION ENGINE
- Match products to specific applications
- Calculate ROI and payback periods  
- Identify rebate opportunities
- Compare against competitors mentioned
- Suggest complementary products/accessories

## OBJECTION HANDLING MATRIX
**"Too expensive"** â†’ ROI calculator, rebate analysis, TCO comparison
**"Need to compare"** â†’ Competitive analysis, unique value props
**"Not ready yet"** â†’ Timeline exploration, planning assistance
**"Unknown brand"** â†’ Quality certifications, case studies, warranty confidence

## CLOSING STRATEGIES
- **Assumptive**: "For your 50,000 sq ft warehouse, we're looking at 24 of the ISF-800W..."
- **Alternative**: "Would you prefer 4000K or 5000K for this application?"
- **Urgency**: "We have these in stock, shipping today. Cree has 6-week lead times."
- **Summary**: "Let me recap the savings: $12K annually in energy, $8K in rebates, minimal maintenance..."

## PARTNERSHIP DEVELOPMENT
- Focus on long-term relationship value
- Offer ongoing technical support
- Suggest phased implementation approaches
- Position as lighting consultant, not just vendor
`,j=c?`
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CONVERSATION CONTEXT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${c}
`:"",k=`
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESPONSE GUIDELINES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- **Tone**: ${d.tone} - match their communication style
- **Length**: Be concise but thorough - respect their time
- **Value**: Every response should educate or move toward solution
- **Questions**: Always end with engaging question to continue dialogue
- **Confidence**: You're the expert - be authoritative but consultative

**Success Metrics**: Build trust â†’ Identify needs â†’ Present solutions â†’ Handle objections â†’ Close partnership

Remember: You're not just selling lights - you're solving business problems and building lasting partnerships. Every interaction should reinforce your expertise and trustworthiness.`;return`${e}${f}${g}${h}${i}${j}${k}`}getRoleBasedGuidance(a){let b=a.toLowerCase();return b.includes("facilities")||b.includes("maintenance")?"Focus on reliability, maintenance savings, warranty coverage. Emphasize 5-year warranty and 100K+ hour lifespan.":b.includes("procurement")||b.includes("purchasing")?"Lead with competitive pricing, volume discounts, delivery reliability. Provide detailed specs for comparison.":b.includes("engineer")||b.includes("technical")?"Deep-dive into technical specs, photometrics, installation details. Share IES files and cut sheets.":b.includes("cfo")||b.includes("finance")?"ROI analysis, payback calculations, rebate maximization. Frame as investment with measurable returns.":b.includes("manager")||b.includes("director")?"Business impact focus - productivity, safety, cost reduction. Position as strategic solution.":"Balanced approach - understand their priorities first, then adapt strategy accordingly."}getProductRecommendations(a,b){let c=a.toLowerCase();return c.includes("parking")||c.includes("lot")?{primary:["ot-series","plb-series"],alternative:["ins-series"],reasoning:"OT and PLB series are specifically designed for parking lot applications with optimal Type III/IV/V distributions for uniform coverage and minimal glare."}:c.includes("warehouse")||c.includes("industrial")||c.includes("manufacturing")?{primary:["ins-series","isf-series"],alternative:["ot-series"],reasoning:"High-bay applications require the power and precision optics of ISF/INS series for uniform illumination at height."}:c.includes("sports")||c.includes("stadium")||c.includes("field")?{primary:["isf-series"],alternative:["ins-series"],reasoning:"ISF series provides broadcast-quality illumination with precise beam control required for professional sports lighting."}:{primary:["ot-series"],alternative:["plb-series","ins-series"],reasoning:"OT series offers versatile solutions for most outdoor commercial lighting applications."}}calculateROI(a,b,c,d=.12){let e=(a-b)*c*365/1e3*d,f=this.estimateProductCost(b);return{annualSavings:e,paybackPeriod:f/e,tenYearSavings:10*e-f}}estimateProductCost(a){return a<=150?179:a<=240?239:a<=400?499:a<=800?899:1299}}let A=new v.Ay({apiKey:process.env.OPENAI_API_KEY}),B=new Map;async function C(a){try{let b,{messages:c,sessionId:d,visitorInfo:e,clientInfo:f}=await a.json();if(!process.env.OPENAI_API_KEY)return u.NextResponse.json({error:"OpenAI API key not configured"},{status:500});let g=d||crypto.randomUUID(),h=new w(process.env.OPENAI_API_KEY),i=new y(process.env.OPENAI_API_KEY),j=new z,k=B.get(g)||{sessionId:g,conversationHistory:[],lastUpdated:new Date};f&&(k={...k,...f});let l=c[c.length-1],m=l.content;if(l.attachments)for(let a of l.attachments)try{switch(a.type){case"audio":if(a.data){let b=await i.processVoice(a.data);m+=`\\n[Voice message transcribed]: ${b}`}break;case"image":if(a.url){let b=await i.processImage(a.url);m+=`\\n[Image analysis]: ${b}`}break;case"pdf":if(a.data){let b=await i.processPDF(a.data);m+=`\\n[Document content]: ${b}`}}}catch(b){console.error(`Failed to process ${a.type}:`,b)}let n=await h.analyzeMessageSentiment(m);if(k.conversationHistory.push({role:l.role,content:m,timestamp:new Date,sentiment:n.sentiment,engagement:n.engagement}),k.company&&k.website)try{if(b=await h.analyzeCompany(k.company,k.website),k.industry=b.industry,k.companySize=b.size,k.position){let a=h.analyzeJobRole(k.position);k.communicationStyle=a.communicationStyle}}catch(a){console.error("Company analysis failed:",a)}if(k.conversationHistory.length>1){let a=k.conversationHistory.filter(a=>"user"===a.role).reduce((a,b)=>a+b.content.length,0)/k.conversationHistory.length;k.messageLength=a<50?"short":a<200?"medium":"long";let b=k.conversationHistory.filter(a=>a.engagement).reduce((a,b)=>a+(b.engagement||50),0)/k.conversationHistory.length;k.interestLevel=b<40?"low":b<70?"medium":"high"}let o=k.conversationHistory.slice(-4).map(a=>`${a.role}: ${a.content}`).join("\\n"),p=j.generatePersonalizedPrompt(k,b,o),q=[{role:"system",content:p},...c.slice(-8).map((a,b)=>({role:a.role,content:b===c.length-1?m:a.content}))],r=await A.chat.completions.create({model:"gpt-4o",messages:q,temperature:.7,max_tokens:800}),s=r.choices[0]?.message?.content||"I apologize, I'm having a technical issue. Let me connect you with our team for immediate assistance.",t=s.match(/\[COLLECT_LEAD:\s*([^\]]+)\]/),v=s.match(/\[ESCALATE:\s*([^\]]+)\]/),x=s.match(/\[ANALYZE_COMPANY:\s*([^\]]+)\]/),C=s.match(/\[VOICE_RESPONSE\]/);s=s.replace(/\[COLLECT_LEAD:[^\]]+\]/g,"").replace(/\[ESCALATE:[^\]]+\]/g,"").replace(/\[ANALYZE_COMPANY:[^\]]+\]/g,"").replace(/\[VOICE_RESPONSE\]/g,"").trim(),k.lastUpdated=new Date,B.set(g,k);let E={reply:s,sessionId:g,clientProfile:{interestLevel:k.interestLevel,communicationStyle:k.communicationStyle,estimatedBudget:b?.budgetEstimate,industry:k.industry}};if(t&&k.email&&(E.leadCollected=!0,E.leadData={name:k.name,email:k.email,phone:k.phone,company:k.company,position:k.position,website:k.website,industry:k.industry,conversationSummary:D(k.conversationHistory),interestLevel:k.interestLevel,estimatedValue:function(a,b){let c="$1,000 - $5,000";b?.size==="enterprise"||b?.size==="fortune500"?c="$50,000 - $200,000+":b?.size==="smb"&&(c="$5,000 - $50,000");let d=a.conversationHistory.map(a=>a.content).join(" ").toLowerCase();return d.includes("stadium")||d.includes("sports")?c="$100,000 - $500,000+":(d.includes("warehouse")||d.includes("industrial"))&&(c="$25,000 - $100,000"),c}(k,b)}),v&&(E.escalate=!0,E.escalateReason=v[1],E.escalateData={clientProfile:k,urgency:n.urgency,conversationSummary:D(k.conversationHistory)}),x&&!b){let[a,c]=x[1].split(",").map(a=>a.trim());if(a)try{E.companyAnalysis=b=await h.analyzeCompany(a,c)}catch(a){console.error("Real-time company analysis failed:",a)}}if(C)try{E.voiceResponse=(await i.generateVoice(s)).toString("base64")}catch(a){console.error("Voice generation failed:",a)}return u.NextResponse.json(E)}catch(b){console.error("Advanced chat API error:",b);let a=b instanceof Error?b.message:"Unknown error";return u.NextResponse.json({error:`Failed to process message: ${a}`,reply:"I apologize for the technical issue. Please email sales@auvolar.com or call (626) 342-8856 for immediate assistance."},{status:500})}}function D(a){return a.filter(a=>"user"===a.role).slice(-5).map(a=>a.content.toLowerCase().includes("parking")?"parking lot lighting":a.content.toLowerCase().includes("warehouse")?"warehouse lighting":a.content.toLowerCase().includes("stadium")?"stadium lighting":a.content.toLowerCase().includes("price")?"pricing inquiry":a.content.toLowerCase().includes("quote")?"quote request":"general inquiry").join(", ")}let E=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/chat-v2/route",pathname:"/api/chat-v2",filename:"route",bundlePath:"app/api/chat-v2/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/home/openclaw/.openclaw/workspace/auvolar-platform-/apps/portal/src/app/api/chat-v2/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:F,workUnitAsyncStorage:G,serverHooks:H}=E;function I(){return(0,g.patchFetch)({workAsyncStorage:F,workUnitAsyncStorage:G})}async function J(a,b,c){var d;let e="/api/chat-v2/route";"/index"===e&&(e="/");let g=await E.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),F=!!(y.dynamicRoutes[D]||y.routes[C]);if(F&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||E.isDev||x||(G="/index"===(G=C)?"/":G);let H=!0===E.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>E.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>E.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await E.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await E.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await E.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},57075:a=>{"use strict";a.exports=require("node:stream")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:a=>{"use strict";a.exports=require("node:fs")},73566:a=>{"use strict";a.exports=require("worker_threads")},74075:a=>{"use strict";a.exports=require("zlib")},79551:a=>{"use strict";a.exports=require("url")},81630:a=>{"use strict";a.exports=require("http")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},90091:()=>{}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4440,6872,9512],()=>b(b.s=56935));module.exports=c})();