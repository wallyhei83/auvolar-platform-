// Auvolar B2B Platform Database Schema
// BigCommerce handles products/orders; this handles Cases, Quotes, Projects, Compliance

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?
  name          String?
  companyName   String?
  phone         String?
  role          UserRole  @default(CUSTOMER)
  bcCustomerId  String?   @unique  // BigCommerce customer ID
  
  // B2B Tier & Rewards
  customerTier    String    @default("BRONZE")  // BRONZE|SILVER|GOLD|PLATINUM
  totalSpent      Decimal   @default(0) @db.Decimal(12,2)
  rewardBalance   Decimal   @default(0) @db.Decimal(10,2)
  
  // Relations
  cases              Case[]
  quotes             Quote[]
  projects           Project[]
  taxExemptDocuments TaxExemptDocument[]
  assignedCases      Case[]    @relation("AssignedCases")
  rewards            CustomerReward[]
  partner             Partner?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([bcCustomerId])
  @@index([email])
}

enum UserRole {
  CUSTOMER
  PARTNER
  STAFF
  ADMIN
  SUPER_ADMIN
}

// ============================================
// PRODUCT DOCUMENTATION
// ============================================

model ProductDocAsset {
  id              String   @id @default(cuid())
  bcProductId     String   // BigCommerce product ID
  sku             String
  docType         DocType
  title           String
  url             String
  version         String?
  fileSize        Int?     // bytes
  mimeType        String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([bcProductId, docType, version])
  @@index([sku])
  @@index([bcProductId])
}

enum DocType {
  CUT_SHEET
  IES
  INSTALL_GUIDE
  DIMENSIONS
  DLC_CERT
  WARRANTY
  OTHER
}

// ============================================
// CASE SYSTEM
// ============================================

model Case {
  id              String     @id @default(cuid())
  caseNumber      String     @unique  // Human readable: CS-2024-00001
  type            CaseType
  status          CaseStatus @default(RECEIVED)
  priority        CasePriority @default(NORMAL)
  
  // SLA
  slaDueAt        DateTime
  slaBreached     Boolean    @default(false)
  
  // Customer info
  customerId      String
  customer        User       @relation(fields: [customerId], references: [id])
  contactEmail    String
  companyName     String?
  
  // Case details
  subject         String
  customerMessage String     @db.Text
  internalNotes   String?    @db.Text
  relatedSkus     String[]   // Array of SKU strings
  relatedOrderIds String[]   // BigCommerce order IDs
  
  // Assignment
  assignedToId    String?
  assignedTo      User?      @relation("AssignedCases", fields: [assignedToId], references: [id])
  
  // Relations
  attachments     CaseAttachment[]
  messages        CaseMessage[]
  quotes          Quote[]
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  closedAt        DateTime?
  
  @@index([customerId])
  @@index([status])
  @@index([type])
  @@index([slaDueAt])
  @@index([assignedToId])
}

enum CaseType {
  RFQ           // Request for Quote
  BOM           // Bill of Materials
  RMA           // Return Merchandise Authorization
  SHIPPING_DAMAGE
  PHOTOMETRIC   // Lighting layout request
  REBATE        // Utility rebate assistance
  NET_TERMS     // Net payment terms application
  SUPPORT       // General support
}

enum CaseStatus {
  RECEIVED
  IN_REVIEW
  NEED_INFO
  COMPLETED
  CLOSED
}

enum CasePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model CaseAttachment {
  id          String   @id @default(cuid())
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  filename    String
  url         String
  mimeType    String?
  fileSize    Int?
  uploadedBy  String   // user ID
  
  createdAt   DateTime @default(now())
  
  @@index([caseId])
}

model CaseMessage {
  id          String   @id @default(cuid())
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  senderId    String   // user ID
  senderName  String
  senderRole  UserRole
  message     String   @db.Text
  isInternal  Boolean  @default(false)  // Internal notes not visible to customer
  
  createdAt   DateTime @default(now())
  
  @@index([caseId])
}

// ============================================
// QUOTE SYSTEM
// ============================================

model Quote {
  id              String      @id @default(cuid())
  quoteNumber     String      @unique  // QT-2024-00001
  version         Int         @default(1)
  
  // Relations
  customerId      String
  customer        User        @relation(fields: [customerId], references: [id])
  caseId          String?
  case            Case?       @relation(fields: [caseId], references: [id])
  projectId       String?
  project         Project?    @relation(fields: [projectId], references: [id])
  
  // Status
  status          QuoteStatus @default(DRAFT)
  validUntil      DateTime
  
  // Line items (JSON for flexibility)
  items           Json        // Array of {sku, name, qty, unitPrice, extPrice, notes}
  
  // Pricing summary
  subtotal        Decimal     @db.Decimal(12, 2)
  discountAmount  Decimal     @default(0) @db.Decimal(12, 2)
  discountPercent Decimal?    @db.Decimal(5, 2)
  shippingAmount  Decimal?    @db.Decimal(12, 2)
  taxAmount       Decimal?    @db.Decimal(12, 2)
  totalAmount     Decimal     @db.Decimal(12, 2)
  
  // Terms
  shippingTerms   String?
  leadTimeTerms   String?
  paymentTerms    String?
  exceptions      String?     @db.Text  // Special terms/conditions
  
  // Acceptance
  acceptedAt      DateTime?
  acceptedBy      String?     // user ID
  bcOrderId       String?     // BigCommerce order created from quote
  
  // Metadata
  createdById     String
  notes           String?     @db.Text
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([customerId])
  @@index([caseId])
  @@index([status])
  @@index([quoteNumber])
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id            String   @id @default(cuid())
  projectName   String
  
  customerId    String
  customer      User     @relation(fields: [customerId], references: [id])
  
  siteAddress   String?
  savedSkus     String[] // Array of SKUs
  notes         String?  @db.Text
  
  // Relations
  quotes        Quote[]
  specPackages  SpecPackage[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([customerId])
}

model SpecPackage {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  name        String
  skus        String[] // SKUs included in this package
  zipUrl      String?  // Generated zip download URL
  generatedAt DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([projectId])
}

// ============================================
// TAX EXEMPTION
// ============================================

model TaxExemptDocument {
  id            String            @id @default(cuid())
  customerId    String
  customer      User              @relation(fields: [customerId], references: [id])
  
  state         String            // US state code
  documentUrl   String
  documentType  String?           // Resale cert, exempt org cert, etc.
  status        TaxExemptStatus   @default(PENDING)
  expiresAt     DateTime?
  
  // Review
  reviewedById  String?
  reviewedAt    DateTime?
  rejectionReason String?
  
  // Audit
  auditLog      Json?             // Array of {action, userId, timestamp, notes}
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  @@index([customerId])
  @@index([status])
  @@index([state])
}

enum TaxExemptStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// ============================================
// PARTNER / DISTRIBUTOR / AFFILIATE SYSTEM
// ============================================

model Partner {
  id            String        @id @default(cuid())
  userId        String        @unique
  user          User          @relation(fields: [userId], references: [id])
  partnerType   PartnerType
  companyName   String
  status        PartnerStatus @default(PENDING)
  
  // Attribution
  referralCode  String        @unique
  
  // Tier & Commission
  tier            DistributorTier @default(BASIC)
  commissionRate  Decimal?        @db.Decimal(5, 2)  // Override rate (null = use tier default)
  totalSales      Decimal         @default(0) @db.Decimal(12, 2)
  totalCommission Decimal         @default(0) @db.Decimal(12, 2)
  pendingPayout   Decimal         @default(0) @db.Decimal(12, 2)
  
  // Equity (for strategic partners)
  equityEligible  Boolean   @default(false)
  equityShares    Decimal?  @db.Decimal(10, 4)
  equityNotes     String?   @db.Text
  
  // Contact
  website       String?
  serviceArea   String?
  description   String?   @db.Text
  
  approvedAt    DateTime?
  approvedById  String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  attributions  PartnerAttribution[]
  payouts       PartnerPayout[]
  
  @@index([referralCode])
  @@index([tier])
  @@index([status])
  @@index([totalSales])
}

enum PartnerType {
  REP
  INSTALLER
  DISTRIBUTOR
}

enum PartnerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum DistributorTier {
  BASIC       // 0+: default commission
  ADVANCED    // $10K+: higher commission
  PARTNER     // $50K+: higher commission + discounts
  STRATEGIC   // $200K+: highest commission + equity eligible
}

model PartnerAttribution {
  id            String              @id @default(cuid())
  partnerId     String
  partner       Partner             @relation(fields: [partnerId], references: [id])
  
  bcOrderId     String              @unique  // BigCommerce order ID
  orderTotal    Decimal             @db.Decimal(12, 2)
  commissionRate Decimal            @db.Decimal(5, 2)  // Rate at time of order
  commission    Decimal             @db.Decimal(12, 2)
  status        CommissionStatus    @default(PENDING)
  
  // Tracking
  customerEmail String?
  customerName  String?
  
  approvedAt    DateTime?
  approvedById  String?
  paidAt        DateTime?
  payoutId      String?
  payout        PartnerPayout?      @relation(fields: [payoutId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([partnerId])
  @@index([bcOrderId])
  @@index([status])
  @@index([payoutId])
}

enum CommissionStatus {
  PENDING     // Order placed, waiting confirmation
  APPROVED    // Order confirmed, commission approved
  PAID        // Commission paid out
  REJECTED    // Self-purchase or fraud
  CANCELLED   // Order cancelled/refunded
}

model PartnerPayout {
  id            String        @id @default(cuid())
  partnerId     String
  partner       Partner       @relation(fields: [partnerId], references: [id])
  
  amount        Decimal       @db.Decimal(12, 2)
  method        String?       // BANK_TRANSFER, CHECK, PAYPAL, etc.
  reference     String?       // Transaction reference
  notes         String?       @db.Text
  status        PayoutStatus  @default(PENDING)
  
  processedAt   DateTime?
  processedById String?
  
  attributions  PartnerAttribution[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@index([partnerId])
  @@index([status])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Commission rules: global defaults, per-product, per-category overrides
model CommissionRule {
  id            String    @id @default(cuid())
  
  // Scope: null = global default for that tier
  tier          DistributorTier?
  bcProductId   String?   // Product-specific override
  bcCategoryId  String?   // Category-specific override
  partnerId     String?   // Partner-specific override
  
  rate          Decimal   @db.Decimal(5, 2)  // Commission percentage
  description   String?
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([tier])
  @@index([bcProductId])
  @@index([bcCategoryId])
  @@index([partnerId])
  @@index([isActive])
}

// Referral tracking: visitor cookie â†’ partner attribution
model ReferralVisit {
  id          String   @id @default(cuid())
  referralCode String
  visitorId   String   // Cookie-based visitor ID
  ipAddress   String?
  userAgent   String?  @db.Text
  landingPage String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  
  convertedAt DateTime?  // When visitor placed an order
  bcOrderId   String?
  
  createdAt   DateTime @default(now())
  
  @@index([referralCode])
  @@index([visitorId])
  @@index([createdAt])
}

// ============================================
// INTEGRATION SYNC LOGS
// ============================================

model QboSyncLog {
  id            String        @id @default(cuid())
  entityType    String        // Order, Payment, Refund, Customer
  sourceId      String        // BigCommerce ID
  qboId         String?       // QuickBooks ID after sync
  status        SyncStatus    @default(PENDING)
  
  attempts      Int           @default(0)
  lastError     String?       @db.Text
  lastAttemptAt DateTime?
  
  payload       Json?         // Request payload for debugging
  response      Json?         // Response for debugging
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@index([entityType, sourceId])
  @@index([status])
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  SKIPPED
}

model ShippingSyncLog {
  id            String     @id @default(cuid())
  bcOrderId     String
  shipmentId    String?    // ShipStation/Shippo ID
  carrier       String?
  trackingNumber String?
  status        SyncStatus @default(PENDING)
  
  attempts      Int        @default(0)
  lastError     String?    @db.Text
  lastAttemptAt DateTime?
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  @@index([bcOrderId])
  @@index([status])
}

// ============================================
// AI KNOWLEDGE BASE
// ============================================

model KnowledgeBaseEntry {
  id          String   @id @default(cuid())
  category    String   // product, policy, faq, etc.
  title       String
  content     String   @db.Text
  sourceUrl   String?  // Link to PDP/policy page
  embedding   Bytes?   // Vector embedding for RAG
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([isActive])
}

model AIChatLog {
  id            String   @id @default(cuid())
  sessionId     String
  userId        String?  // null for guests
  
  userMessage   String   @db.Text
  aiResponse    String   @db.Text
  sourcesUsed   String[] // URLs cited
  
  handoffCaseId String?  // If escalated to a Case
  feedbackRating Int?    // 1-5 user rating
  
  createdAt     DateTime @default(now())
  
  @@index([sessionId])
  @@index([userId])
}

// ============================================
// CASE STUDIES (Project Showcases)
// ============================================

model CaseStudy {
  id            String   @id @default(cuid())
  slug          String   @unique
  category      String   // "Parking Lot Lighting", "Auto Dealership Lighting", etc.
  title         String
  subtitle      String?
  description   String   @db.Text
  highlights    String[] // Array of bullet points
  product       String?  // Product name reference
  productSlug   String?  // Link to /p/[slug]
  clients       String[] // Client names
  location      String?
  images        String[] // URLs (Vercel Blob or public paths)
  youtubeId     String?
  stats         Json?    // Array of {label, value}
  sortOrder     Int      @default(0)
  isPublished   Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([category])
  @@index([isPublished])
  @@index([sortOrder])
}

// ============================================
// ANALYTICS EVENTS (for operational reporting)  
// ============================================

model AnalyticsEvent {
  id          String   @id @default(cuid())
  eventName   String
  userId      String?
  sessionId   String?
  properties  Json?
  
  createdAt   DateTime @default(now())
  
  @@index([eventName])
  @@index([createdAt])
}

// ============================================
// AI SALES SYSTEM - CLIENT INTELLIGENCE & LEARNING
// ============================================

model AIClientProfile {
  id            String    @id @default(cuid())
  sessionId     String    @unique
  
  // Basic Info
  name          String?
  email         String?
  phone         String?  
  company       String?
  website       String?
  position      String?
  
  // Intelligence Data
  industry      String?
  companySize   CompanySize?
  communicationStyle String? // 'direct', 'relationship', 'analytical', 'expressive'
  decisionSpeed String?     // 'fast', 'moderate', 'slow'
  techLevel     String?     // 'expert', 'intermediate', 'basic'
  priceSensitivity String?  // 'high', 'medium', 'low'
  
  // Behavioral Analysis
  avgResponseTime Int?      // milliseconds
  messageLength   String?   // 'short', 'medium', 'long'  
  interestLevel   String?   // 'low', 'medium', 'high'
  
  // Business Context
  painPoints    String[]    // Array of identified pain points
  budget        String?
  timeline      String?
  competitors   String[]    // Competitors mentioned
  
  // Conversation Summary
  conversationSummary String? @db.Text
  totalMessages       Int     @default(0)
  avgSentiment       Float?   // -1 to 1
  avgEngagement      Float?   // 0 to 100
  
  // Learning Data
  strategyEffectiveness Json? // Record<strategy, effectiveness_score>
  
  // Relations
  conversations AIConversation[]
  leadData      AILeadData?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastActiveAt  DateTime  @default(now())
  
  @@index([email])
  @@index([company])
  @@index([industry])
  @@index([interestLevel])
  @@index([lastActiveAt])
}

enum CompanySize {
  STARTUP
  SMB  
  ENTERPRISE
  FORTUNE500
}

model AIConversation {
  id            String    @id @default(cuid())
  sessionId     String
  profileId     String
  
  role          String    // 'user' or 'assistant'
  content       String    @db.Text
  messageType   String?   // 'text', 'image', 'voice', 'document'
  attachments   Json?     // Array of attachment info
  
  // Analysis Data
  sentiment     Float?    // -1 to 1
  engagement    Float?    // 0 to 100
  intent        String[]  // Array of detected intents
  urgency       String?   // 'low', 'medium', 'high'
  
  // AI Strategy
  strategy      String?   // Strategy used for this response
  effectiveness Float?    // How effective was this strategy (0-1)
  
  profile       AIClientProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  
  @@index([sessionId])
  @@index([profileId])
  @@index([createdAt])
}

model AILeadData {
  id            String    @id @default(cuid())
  profileId     String    @unique
  
  // Lead Qualification
  leadScore     Int       @default(0) // 0-100
  leadStatus    LeadStatus @default(NEW)
  estimatedValue String?  // '$1K-5K', '$5K-50K', etc.
  
  // Sales Process
  salesStage    SalesStage @default(DISCOVERY)
  nextAction    String?    @db.Text
  notes         String?    @db.Text
  
  // Assignment  
  assignedTo    String?    // Staff user ID
  followUpAt    DateTime?
  
  // Conversion Tracking
  convertedAt   DateTime?
  conversionValue Float?
  
  profile       AIClientProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([leadStatus])
  @@index([salesStage])
  @@index([leadScore])
  @@index([assignedTo])
  @@index([followUpAt])
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
  ARCHIVED
}

enum SalesStage {
  DISCOVERY
  NEEDS_ANALYSIS
  PROPOSAL
  NEGOTIATION
  CLOSING
  FOLLOW_UP
}

model AICompanyIntelligence {
  id            String    @id @default(cuid())
  companyName   String    @unique
  website       String?
  
  // Company Data
  industry      String?
  size          CompanySize?
  description   String?   @db.Text
  
  // Intelligence
  painPoints    String[]  // Common pain points for this industry/company
  budgetEstimate String?
  decisionMakers String[] // Array of typical decision maker roles
  competitors   String[]  // Our competitors they might consider
  
  // News & Context
  recentNews    Json?     // Array of recent news items
  marketTrends  Json?     // Relevant market trends
  
  // Contact Info
  phone         String?
  email         String?
  address       String?
  
  // Usage Stats
  timesAnalyzed Int       @default(1)
  lastAnalyzed  DateTime  @default(now())
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([industry])
  @@index([size])
  @@index([lastAnalyzed])
}

model AIStrategyPerformance {
  id            String    @id @default(cuid())
  strategy      String    // Strategy name/type
  
  // Context
  industry      String?
  companySize   CompanySize?
  clientType    String?   // Role/position type
  
  // Performance Metrics  
  timesUsed     Int       @default(1)
  avgEffectiveness Float  @default(0.5) // 0-1
  conversionRate Float?   // Leads that converted
  avgEngagement Float?    // Average engagement score
  
  // Learning Data
  successFactors Json?    // What makes this strategy work
  failureReasons Json?    // Why it sometimes fails
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([strategy, industry, companySize, clientType])
  @@index([strategy])
  @@index([avgEffectiveness])
  @@index([conversionRate])
}

// ============================================
// CUSTOMER REWARDS & LOYALTY
// ============================================

model CustomerReward {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // EARNED | REDEEMED | EXPIRED | ADJUSTMENT
  amount      Decimal  @db.Decimal(10,2)
  description String
  orderId     String?  // BC order ID if applicable
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([type])
}
