// Auvolar B2B Platform Database Schema
// BigCommerce handles products/orders; this handles Cases, Quotes, Projects, Compliance

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?
  name          String?
  companyName   String?
  phone         String?
  role          UserRole  @default(CUSTOMER)
  bcCustomerId  String?   @unique  // BigCommerce customer ID
  
  // Relations
  cases              Case[]
  quotes             Quote[]
  projects           Project[]
  taxExemptDocuments TaxExemptDocument[]
  assignedCases      Case[]    @relation("AssignedCases")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([bcCustomerId])
  @@index([email])
}

enum UserRole {
  CUSTOMER
  PARTNER
  STAFF
  ADMIN
  SUPER_ADMIN
}

// ============================================
// PRODUCT DOCUMENTATION
// ============================================

model ProductDocAsset {
  id              String   @id @default(cuid())
  bcProductId     String   // BigCommerce product ID
  sku             String
  docType         DocType
  title           String
  url             String
  version         String?
  fileSize        Int?     // bytes
  mimeType        String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([bcProductId, docType, version])
  @@index([sku])
  @@index([bcProductId])
}

enum DocType {
  CUT_SHEET
  IES
  INSTALL_GUIDE
  DIMENSIONS
  DLC_CERT
  WARRANTY
  OTHER
}

// ============================================
// CASE SYSTEM
// ============================================

model Case {
  id              String     @id @default(cuid())
  caseNumber      String     @unique  // Human readable: CS-2024-00001
  type            CaseType
  status          CaseStatus @default(RECEIVED)
  priority        CasePriority @default(NORMAL)
  
  // SLA
  slaDueAt        DateTime
  slaBreached     Boolean    @default(false)
  
  // Customer info
  customerId      String
  customer        User       @relation(fields: [customerId], references: [id])
  contactEmail    String
  companyName     String?
  
  // Case details
  subject         String
  customerMessage String     @db.Text
  internalNotes   String?    @db.Text
  relatedSkus     String[]   // Array of SKU strings
  relatedOrderIds String[]   // BigCommerce order IDs
  
  // Assignment
  assignedToId    String?
  assignedTo      User?      @relation("AssignedCases", fields: [assignedToId], references: [id])
  
  // Relations
  attachments     CaseAttachment[]
  messages        CaseMessage[]
  quotes          Quote[]
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  closedAt        DateTime?
  
  @@index([customerId])
  @@index([status])
  @@index([type])
  @@index([slaDueAt])
  @@index([assignedToId])
}

enum CaseType {
  RFQ           // Request for Quote
  BOM           // Bill of Materials
  RMA           // Return Merchandise Authorization
  SHIPPING_DAMAGE
  PHOTOMETRIC   // Lighting layout request
  REBATE        // Utility rebate assistance
  NET_TERMS     // Net payment terms application
  SUPPORT       // General support
}

enum CaseStatus {
  RECEIVED
  IN_REVIEW
  NEED_INFO
  COMPLETED
  CLOSED
}

enum CasePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model CaseAttachment {
  id          String   @id @default(cuid())
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  filename    String
  url         String
  mimeType    String?
  fileSize    Int?
  uploadedBy  String   // user ID
  
  createdAt   DateTime @default(now())
  
  @@index([caseId])
}

model CaseMessage {
  id          String   @id @default(cuid())
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  senderId    String   // user ID
  senderName  String
  senderRole  UserRole
  message     String   @db.Text
  isInternal  Boolean  @default(false)  // Internal notes not visible to customer
  
  createdAt   DateTime @default(now())
  
  @@index([caseId])
}

// ============================================
// QUOTE SYSTEM
// ============================================

model Quote {
  id              String      @id @default(cuid())
  quoteNumber     String      @unique  // QT-2024-00001
  version         Int         @default(1)
  
  // Relations
  customerId      String
  customer        User        @relation(fields: [customerId], references: [id])
  caseId          String?
  case            Case?       @relation(fields: [caseId], references: [id])
  projectId       String?
  project         Project?    @relation(fields: [projectId], references: [id])
  
  // Status
  status          QuoteStatus @default(DRAFT)
  validUntil      DateTime
  
  // Line items (JSON for flexibility)
  items           Json        // Array of {sku, name, qty, unitPrice, extPrice, notes}
  
  // Pricing summary
  subtotal        Decimal     @db.Decimal(12, 2)
  discountAmount  Decimal     @default(0) @db.Decimal(12, 2)
  discountPercent Decimal?    @db.Decimal(5, 2)
  shippingAmount  Decimal?    @db.Decimal(12, 2)
  taxAmount       Decimal?    @db.Decimal(12, 2)
  totalAmount     Decimal     @db.Decimal(12, 2)
  
  // Terms
  shippingTerms   String?
  leadTimeTerms   String?
  paymentTerms    String?
  exceptions      String?     @db.Text  // Special terms/conditions
  
  // Acceptance
  acceptedAt      DateTime?
  acceptedBy      String?     // user ID
  bcOrderId       String?     // BigCommerce order created from quote
  
  // Metadata
  createdById     String
  notes           String?     @db.Text
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([customerId])
  @@index([caseId])
  @@index([status])
  @@index([quoteNumber])
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id            String   @id @default(cuid())
  projectName   String
  
  customerId    String
  customer      User     @relation(fields: [customerId], references: [id])
  
  siteAddress   String?
  savedSkus     String[] // Array of SKUs
  notes         String?  @db.Text
  
  // Relations
  quotes        Quote[]
  specPackages  SpecPackage[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([customerId])
}

model SpecPackage {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  name        String
  skus        String[] // SKUs included in this package
  zipUrl      String?  // Generated zip download URL
  generatedAt DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([projectId])
}

// ============================================
// TAX EXEMPTION
// ============================================

model TaxExemptDocument {
  id            String            @id @default(cuid())
  customerId    String
  customer      User              @relation(fields: [customerId], references: [id])
  
  state         String            // US state code
  documentUrl   String
  documentType  String?           // Resale cert, exempt org cert, etc.
  status        TaxExemptStatus   @default(PENDING)
  expiresAt     DateTime?
  
  // Review
  reviewedById  String?
  reviewedAt    DateTime?
  rejectionReason String?
  
  // Audit
  auditLog      Json?             // Array of {action, userId, timestamp, notes}
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  @@index([customerId])
  @@index([status])
  @@index([state])
}

enum TaxExemptStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// ============================================
// PARTNER / COMMISSION (Phase 2)
// ============================================

model Partner {
  id            String        @id @default(cuid())
  userId        String        @unique
  partnerType   PartnerType
  companyName   String
  status        PartnerStatus @default(PENDING)
  
  // Attribution
  referralCode  String        @unique
  
  // Commission
  commissionRate Decimal?     @db.Decimal(5, 2)  // Percentage
  
  approvedAt    DateTime?
  approvedById  String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  attributions  PartnerAttribution[]
  
  @@index([referralCode])
}

enum PartnerType {
  REP
  INSTALLER
  DISTRIBUTOR
}

enum PartnerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

model PartnerAttribution {
  id          String   @id @default(cuid())
  partnerId   String
  partner     Partner  @relation(fields: [partnerId], references: [id])
  
  bcOrderId   String   // BigCommerce order ID
  orderTotal  Decimal  @db.Decimal(12, 2)
  commission  Decimal  @db.Decimal(12, 2)
  paidAt      DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([partnerId])
  @@index([bcOrderId])
}

// ============================================
// INTEGRATION SYNC LOGS
// ============================================

model QboSyncLog {
  id            String        @id @default(cuid())
  entityType    String        // Order, Payment, Refund, Customer
  sourceId      String        // BigCommerce ID
  qboId         String?       // QuickBooks ID after sync
  status        SyncStatus    @default(PENDING)
  
  attempts      Int           @default(0)
  lastError     String?       @db.Text
  lastAttemptAt DateTime?
  
  payload       Json?         // Request payload for debugging
  response      Json?         // Response for debugging
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@index([entityType, sourceId])
  @@index([status])
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  SKIPPED
}

model ShippingSyncLog {
  id            String     @id @default(cuid())
  bcOrderId     String
  shipmentId    String?    // ShipStation/Shippo ID
  carrier       String?
  trackingNumber String?
  status        SyncStatus @default(PENDING)
  
  attempts      Int        @default(0)
  lastError     String?    @db.Text
  lastAttemptAt DateTime?
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  @@index([bcOrderId])
  @@index([status])
}

// ============================================
// AI KNOWLEDGE BASE
// ============================================

model KnowledgeBaseEntry {
  id          String   @id @default(cuid())
  category    String   // product, policy, faq, etc.
  title       String
  content     String   @db.Text
  sourceUrl   String?  // Link to PDP/policy page
  embedding   Bytes?   // Vector embedding for RAG
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([isActive])
}

model AIChatLog {
  id            String   @id @default(cuid())
  sessionId     String
  userId        String?  // null for guests
  
  userMessage   String   @db.Text
  aiResponse    String   @db.Text
  sourcesUsed   String[] // URLs cited
  
  handoffCaseId String?  // If escalated to a Case
  feedbackRating Int?    // 1-5 user rating
  
  createdAt     DateTime @default(now())
  
  @@index([sessionId])
  @@index([userId])
}

// ============================================
// ANALYTICS EVENTS (for operational reporting)
// ============================================

model AnalyticsEvent {
  id          String   @id @default(cuid())
  eventName   String
  userId      String?
  sessionId   String?
  properties  Json?
  
  createdAt   DateTime @default(now())
  
  @@index([eventName])
  @@index([createdAt])
}
